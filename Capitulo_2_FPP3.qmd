---
title: "Capítulo 2 FPP3"
author: "Eddie Aguilar"
format:
  html:
    self-contained: true
editor: source
---

```{r}
library(tidyverse)
library(fpp3)
```

# Book

```{r}
# How to make a tsibble: 

(y <- tsibble(
  Year = 2015:2019,
  Observation = c(123, 39, 78, 52, 110),
  index = Year
))

# Out of a tibble:
(y <- tibble(
  Year = 2015:2019,
  Observation = c(123, 39, 78, 52, 110)
) %>% 
  as_tsibble(index = Year))
```


Using ansett tsibble, we graph only the flights from Melbourne to Sydney in economy class, we can see 
several drops on christmas day due to the lack of flights that day of the year, several values of 0 before 1990.

```{r}
ansett

melsyd_economy <- ansett |>
  filter(Airports == "MEL-SYD", Class == "Economy") |>
  mutate(Passengers = Passengers/1000)
autoplot(melsyd_economy, Passengers) +
  labs(title = "Ansett airlines economy class",
       subtitle = "Melbourne-Sydney",
       y = "Passengers ('000)")
```

## Time series patterns

Trend: When there is a long-term increase or decrease in the data. 

Seasonal: A series is influenced by seasonal factors.

Cyclic: Rises and falls in the data that are not of fixed period.

NOTE: Annual data cannot have seasonal pattern.


```{r}
us_employment %>% 
  filter(Title == "Retail Trade", year(Month) >= 1980) %>% 
  autoplot(Employed / 1e3) +
  labs(y = "Milllion people", title = "Retail employment, USA")
```

We can see an overall increasing trend, an obvious seasonal pattern every summer in the US and finally a cycle every several years.



## Seasonal plot

```{r}
# Daily
vic_elec |> gg_season(Demand, period = "day") +
  theme(legend.position = "none") +
  labs(y="MWh", title="Electricity demand: Victoria")

# Weekly
vic_elec |> gg_season(Demand, period = "week") +
  theme(legend.position = "none") +
  labs(y="MWh", title="Electricity demand: Victoria")

# Annual
vic_elec |> gg_season(Demand, period = "year") +
  labs(y="MWh", title="Electricity demand: Victoria")
```


## Seasonal subseries plots

```{r}
holidays <- tourism |>
  filter(Purpose == "Holiday") |>
  group_by(State) |>
  summarise(Trips = sum(Trips))

gg_season(holidays, Trips) +
  labs(y = "Overnight trips ('000)",
       title = "Australian domestic holidays")
```


```{r}
holidays |>
  gg_subseries(Trips) +
  labs(y = "Overnight trips ('000)",
       title = "Australian domestic holidays")
```

## Correlation matrices

```{r}
visitors <- tourism |>
  group_by(State) |>
  summarise(Trips = sum(Trips))
visitors |>
  ggplot(aes(x = Quarter, y = Trips)) +
  geom_line() +
  facet_grid(vars(State), scales = "free_y") +
  labs(title = "Australian domestic tourism",
       y= "Overnight trips ('000)")
```

```{r}
visitors |>
  pivot_wider(values_from=Trips, names_from=State) |>
  GGally::ggpairs(columns = 2:9)
```

## Lag plots

Lag 1 graphs each quarter against the previous quarter.

Lag 2 graphs each quarter against 2 previous quarter.

And so on...

```{r}
recent_production <- aus_production |>
  filter(year(Quarter) >= 2000)
recent_production |>
  gg_lag(Beer, geom = "point") +
  labs(x = "lag(Beer, k)")
```
We can see lag 4 and lag 8 have a strong positive correlation, that is due to the seasonal pattern every year(summer)


## Autocorreltaion functions (ACF)

When having all the lags from the previous topic, we can calculate the autocorreltaion of each lag, 
which is what we graphed in the lag plots, but now with values. 

Once we have those values, we are going to be able to see the same patterns, strong negative correlation in lag 2, 6, 10, ... and strong positive correlation in lag 4, 8, ...
That's due to trend, seasonality and a combination of both. 

Some rules: 

- When data have a trend, the autocorrelations for small lags tend to be large and positive.
- When data are seasonal, the autocorrelations will be larger at the seasonal lags.
- When data have both, you see a combination of these effects.

```{r}
recent_production |> ACF(Beer, lag_max = 9)
```

We plot them:

```{r}
recent_production |>
  ACF(Beer) |>
  autoplot() + labs(title="Australian beer production")
```


## White noise

These occurs when there is no seasonality, trend so the autocorrelations are close to 0 (Everything is all over the place and seems random).

It's uncorrealated, with zero mean and constant variance.

Let's make some random graph:

```{r}
set.seed(30)
y <- tsibble(sample = 1:50, wn = rnorm(50), index = sample)
y |> autoplot(wn) + labs(title = "White noise", y = "")
```

```{r}
y |>
  ACF(wn) |>
  autoplot() + labs(title = "White noise")
```

As we can see, there is really no spikes out of the range.

That´s why the range (blue line) is really important to graph, which is the 95% of critical values.

# Exercises

## 1. 

```{r}
autoplot(aus_production, Bricks)
autoplot(pelt, Lynx)
autoplot(gafa_stock, Close)
autoplot(vic_elec, Demand)
```

## 2.

```{r}
group_by(gafa_stock, Symbol) %>% 
  filter(Close == max(Close)) %>% 
  select(Symbol, Date, Close)
```

## 3. 

a.
```{r}
tute1 <- readr::read_csv("Excels/tute1.csv")
View(tute1)
```
b. 
```{r}
(tute <- tute1 |>
  mutate(Quarter = yearquarter(Quarter)) |>
  as_tsibble(index = Quarter))
```

c.
```{r}
tute |>
  pivot_longer(-Quarter) |>
  ggplot(aes(x = Quarter, y = value, colour = name)) +
  geom_line() +
  facet_grid(name ~ ., scales = "free_y")
```
## 4. 

a. 
```{r}
library("USgas")
```
b. 
```{r}
(us_total |> 
  as_tsibble(index = year, key = state) -> us_total)
```

c. 
```{r}
filter(us_total, state %in% c("Maine", "Vermont", "New Hampshire", "Massachusetts", "Connecticut", "Rhode Island")) |> 
  ggplot(aes(x = year, y = y)) +
  geom_line(aes(color = state)) + 
  labs(y = "Gas consumption", title = "Annual natural gas consumption")
```
## 5. 

a. 

```{r}
tourism <- readxl::read_excel("Excels/tourism.xlsx")
```

b.
```{r}

(mutate(tourism, Quarter = yearquarter(Quarter)) |> 
  as_tsibble(index = Quarter, key = c(Region, State, Purpose)) -> tourism)

tsibble::tourism 
```

c. 

```{r}

group_by(tourism, Region, Purpose) |> 
  filter(Trips == max(Trips)) |> 
  select(-State) |> 
  arrange(desc(Trips))

# Melbourne, Visiting
```

d. 
```{r}
(state_tourism <- group_by(tourism, State) |> 
   summarise(total_Trips = sum(Trips)))
```

## 6. 

```{r}
aus_arrivals
autoplot(aus_arrivals)
gg_season(aus_arrivals)
gg_subseries(aus_arrivals)
```
As we can see all 4 different origins have a seasonal pattern, some more than others, with UK being the one with more oscillation every year and US the less, this means there are certain events or weather between UK and Asutralia that makes people travel to Australia depending on the time of the year. 

We can also see that Japan had an increasing trend until 1996, all the others present and slight or more visible increasing trend all along. 

In the seasonal plot we can confirm all the previous observations made about seasonality and can also see when the seasonlity comes from (quarters of the year) for each country.


## 7. 


```{r}
set.seed(352)
retail <- aus_retail |>
  filter(`Series ID` == sample(aus_retail$`Series ID`,1))

retail
```

```{r}
autoplot(retail, Turnover)
gg_season(retail, Turnover)
gg_subseries(retail, Turnover)
gg_lag(retail, Turnover, geom = "point")
autoplot(ACF(retail, Turnover))
```

As we can see in our initial plot, we have Victoria's retail turnover seperated by month, we can notice an obviuos upwards trend which is probably a little bit exponential by the end of the graph, we can also see an seasonality which is bigger as the amount of turnovers are increasing (proportional).

In the seasonal plot we can spot where the spikes of seasonality are, which are due to holidays, we can also see a more irregular spike through the years in summer break. 

In the seasonal subseries plot we can confirm the proportion between spikes and amount of turnovers with december being the month with more turnovers but also, having an increase in turnovers throughout the years. 

Due to the combination of strong seasonality and upwards trend, all lags between several months have a very strong autocorrelation. 

We can confirm when we plot the autocorrelation function, we can see how every value is way above the range, due to strong upwards trend, and how there a few spikes every 12 months, due to seasonality.

## 8.



```{r}
(us_employment <- filter(us_employment, Title == "Total Private"))
autoplot(us_employment, Employed)
gg_season(us_employment, Employed)
gg_subseries(us_employment, Employed)
gg_lag(us_employment, Employed, geom = "point")
autoplot(ACF(us_employment, Employed))
```
Strong upwards trend, very small seasonality, we can confirm this in the seasonal plot, though there is an slight drop in the trend around 2010, we can see this in the seasonal subseries plot, it has strong positive correlation due to seasonality and trend, we can see how ACF is being affected by the strong trend and there is not much difference in multiples of 12 (annual) due to an small seasonality.

```{r}
aus_production
autoplot(aus_production, Bricks)
gg_season(aus_production, Bricks)
gg_subseries(aus_production, Bricks)
gg_lag(aus_production, Bricks, geom = "point")
autoplot(ACF(aus_production, Bricks))
```

We can see an increasing trend in the first half, then two important drops, and after that it stayed very regular in a general perspective, has a seasonality which varies a little bit everytime. Looking at the seasonal plot we can see a very confirm the highs and lows in the second half and how seasonality stops being simple compared to the first half. Due to loss of strong trend and not very defined seasonality, the correlations and lags are not very strong. But we can also see how there is a seasonality every four-month period.

```{r}
(pelt = pelt %>% as_tsibble(index = Year))
autoplot(pelt, Hare)
gg_lag(pelt, Hare, geom = "point")
autoplot(ACF(pelt, Hare))
```
This data is annual, so it's  unfair to say it has seasonality throughout the years due to the lack of information in each year. Nevertheless, we can try to analyze this data, and looking at the line plot and acf plot, we can notice a seasonality every 10 years, with a whole cycle of a drop and a spike.

```{r}
(PB <- tsibbledata::PBS %>% 
   as_tibble() %>% 
   group_by(Month, ATC2) %>% 
   summarise(Cost = sum(Cost)) %>% 
   as_tsibble(index = Month, key = ATC2) %>% 
   filter(ATC2 == "H02"))

autoplot(PB, Cost)
gg_season(PB, Cost)
gg_subseries(PB, Cost)
gg_lag(PB, Cost, geom = "point")
autoplot(ACF(PB, Cost))
```
We can see a clear and very strong seasonlity with a big drop in January and recovery proccess the whole year until it ends in the same point. This with a general upwards trend. In the seasonal plot we can see how the drop is very clean and spontenaous, and how the whole year it recovers with very different highs and lows. We can see in ACF how the annual seasonality is very strong, and all the other correlations are very weak due to very different values throughout the year.

```{r}
us_gasoline
autoplot(us_gasoline, Barrels)
gg_season(us_gasoline, Barrels)
gg_subseries(us_gasoline, Barrels)
gg_lag(us_gasoline, Barrels, geom = "point")
autoplot(ACF(us_gasoline, Barrels))
```
We can see a general upwards trend which slightly stops and changes at the end of the graphic, we can see a lot of changes in the seasonal plot due to weekly data. Strong correlations due to seasonality and trend.

## 9.

2A, 3D, 1B, 4C


## 10.

```{r}
aus_live <- filter(aus_livestock, year(Month) >= 1990 & year(Month) <= 1995, State == "Victoria", Animal == "Pigs")
autoplot(aus_live, Count)
autoplot(ACF(aus_live, Count))
```
We can see a very obvious cahnge, when we filter the data, we see a strong upwards trend, this graph can actually be a cycle in the whole picture and life of the data instead of a general trend, We reveal this when we use all the data. This makes the range of the ACF be bigger and closer to the data in the filtered one.


## 11. 

a.

```{r}
(gafa_stock |>
  filter(Symbol == "GOOG", year(Date) >= 2018) |>
  mutate(trading_day = row_number()) %>% 
  mutate(diff = difference(Close)) -> dgoog1)
(dgoog <- gafa_stock |>
  filter(Symbol == "GOOG", year(Date) >= 2018) |>
  mutate(trading_day = row_number()) |>
  update_tsibble(index = trading_day, regular = TRUE) |>
  mutate(diff = difference(Close)))
```

b.

Because a stock doesn't have a continous index due to not having any data in the weekends, that's why we change to trade number and the data can be continuous. We can see this change in the line plot. But we cannot really see a difference in ACF.
c.

```{r}
autoplot(dgoog, Close)
autoplot(ACF(dgoog, Close))

autoplot(dgoog1, Close)
autoplot(ACF(dgoog1, Close))


```

d.

In a general point, there is no real difference between these two, the correlations graphed are the same.
