---
title: "Proyecto"
author: "Eddie Aguilar"
format: revealjs
df-print: paged
embed-resources: true
execute: 
  warning: false
---

## Serie de tiempo

- Exportaciones mensuales de Canadá (1960 - 2022)

- Siglo presente

## Librerías

- Tidyverse
- fpp3
- Patchwork
- Plotly

```{r}
#| message: false
library("tidyverse")
library("fpp3") 
library("patchwork")
library("plotly")
```

## Importación y tsibble

```{r}
exports <- tidyquant::tq_get(x = "XTEXVA01CAM667S", get = "economic.data", from = "2000-01-01")

exports_t <- exports |> 
  as_tsibble( index = date, key = symbol ) |> 
  rename( dollars_monthly = price) %>% 
  mutate(date = yearmonth(date))
exports_t
```

## Visualización

```{r}
exports_t %>% autoplot(dollars_monthly) + ggtitle("Exportaciones de Canadá") + ylab("Dólares (USD) mensuales") + xlab("Mes")
```

## Inspección visual

- Después de limpieza de datos.

- Relleno en gráfica.

```{r}
exports_t <-  exports_t |> na.omit(exports_t)
exports_t |> 
  autoplot(dollars_monthly) + geom_area(color="black", fill = "light green") + ggtitle("Inspección") + ylab("Dólares (USD) mensuales") + xlab("Mes")
```

## Outliers

- Abril 2008
- Marzo 2009
- Febrero 2020
- Julio 2021

```{r}
exports_t %>% autoplot(dollars_monthly) + ggtitle("Exportaciones de Canadá") + ylab("Dólares (USD) mensuales") + xlab("Mes")
```

## Ajuste y transformación matemática

- Transformación logarítmica

```{r}
exports_t %>% autoplot(dollars_monthly) + ggtitle("Sin transformación") + ylab("Dólares (USD) mensuales") + xlab("Mes")

```


## Ajuste y transformación matemática

- Transformación logarítmica

```{r}
exports_t %>% autoplot(log(dollars_monthly)) + ggtitle("Con transformación") + ylab("Dólares (USD) mensuales") + xlab("Mes")
```

## Descomposición

```{r}
exports_d <- exports_t %>%
  model(STL(log(dollars_monthly),robust = TRUE)) %>%
  components() 
autoplot(exports_d) 
```

## Entrenamiento

- A partir de 2000
- Enero de 2022

```{r}
#| warning: false
exports_train <- exports_t %>% filter_index('2000' ~ '2022-01-01')
```


## Benchmark 

- Descartar media, naive.

- Usar snaive y drift.


## Benchmark

```{r}
#| warning: false
exports_fit <- exports_train|> model( snaive = SNAIVE(log(dollars_monthly)),
                              drift = RW(log(dollars_monthly) ~ drift() ))

exports_fit |> forecast(h=24) |> autoplot(exports_t |> filter_index("2017"~.)) + ggtitle("Pronósticos con Benchmark ")  + xlab("Mes") + ylab("Dólares (USD) mensuales")
```

## Errores de benchmark

```{r}
accuracy(exports_fit) %>% 
  select(.model, .type, MAE, RMSE, MAPE, MASE) %>% 
  arrange(MAPE)
```

## Residuales

```{r}
exports_fit |> select(snaive) |> gg_tsresiduals() + ggtitle('Residuales del modelo snaive')
```

## Residuales 

```{r}
exports_fit |> select(drift) |> gg_tsresiduals() + ggtitle('Residuales del modelo drift')
```


## ETS

```{r}
exports_fit2 <- exports_train |> 
      model(
        ETS = decomposition_model(
                          STL(log(dollars_monthly), robust = TRUE),
                          ETS(season_adjust ~ error("A") + trend("Ad") + season("N"))),
        autoETS = ETS(log(dollars_monthly))
        )

accuracy(exports_fit2) |> 
  select(.model, .type, MAE, RMSE, MAPE, MASE) |>
  arrange(MAPE)
```


## ljung_box

```{r}
exports_fit2 %>% augment() %>% features(.innov, ljung_box, lag = 24, dof=0)
```

## Residuales

```{r}
exports_fit2 |> select(ETS) |> gg_tsresiduals() + ggtitle('Residuales del modelo de descomposición')
```

## Residuales

```{r}
exports_fit2 |> select(autoETS) |> gg_tsresiduals() + ggtitle('Residuales del modelo automático')
```

## ARIMA

- Prueba de raíz unitaria: (Diferenciación estacional)

```{r}
exports_t |> features(dollars_monthly, unitroot_ndiffs)
exports_t |> mutate(dollars_monthly = difference(dollars_monthly, lag = 12)) |> features(dollars_monthly, unitroot_ndiffs)
```

## Autocorrelación y autocorrelación parcial

```{r}
exports_diff <- exports_train |> mutate(exports_diff1 = difference(dollars_monthly),
                                          exports_diff2 = difference(dollars_monthly, lag =12) |> difference(lag =1))

exports_diff |> gg_tsdisplay(exports_diff1, plot_type = "partial") + ggtitle("Primeras Diferencias")


```


## Autocorrelación y autocorrelación parcial

```{r}
exports_diff |> gg_tsdisplay(exports_diff2, plot_type = "partial") + ggtitle("Estacionales")
```

## ARIMA

- Sugeridos: p = 1, q = 1, P = 2, Q = 1

```{r}
exports_fit3 <- exports_train |>
  model(
    autoARIMA = ARIMA(dollars_monthly  ~ pdq() + PDQ(0, 0, 0)),
    SARIMA = ARIMA(dollars_monthly  ~ pdq(0,1,1) + PDQ(D=1)))

accuracy(exports_fit3) |> 
  select(.model, .type, MAE, RMSE, MAPE, MASE) |>
  arrange(MAPE)
```

## Reportes

```{r}
report(exports_fit3 |> select(autoARIMA))
report(exports_fit3 |> select(SARIMA))
```

## Mejorar modelos

```{r}
exports_fit3 <- exports_train |>
  model(
    autoARIMA = ARIMA(dollars_monthly  ~ pdq(0,1,1) + PDQ(0, 1, 1)),
    SARIMA = ARIMA(dollars_monthly  ~ pdq(0,1,1) + PDQ(2,1,0)))

accuracy(exports_fit3) |> 
  select(.model, .type, MAE, RMSE, MAPE, MASE) |>
  arrange(MAPE)
```

## Mabble

```{r}
exports_mabble <- exports_train |>
  model(
    drift = RW(log(dollars_monthly) ~ drift()),
    ETS = decomposition_model(
                          STL(log(dollars_monthly), robust = TRUE),
                          ETS(season_adjust ~ error("A") + trend("Ad") + season("N"))),
    SARIMA = ARIMA(dollars_monthly  ~ pdq(0,1,1) + PDQ(2,1,0)))
  
accuracy(exports_mabble) |> 
  select(.model, .type, MAE, RMSE, MAPE, MASE) |>
  arrange(MAPE)
```


## Modelos combinados

```{r}
exports_comb <- exports_train %>% 
  model(
    drift_ETS = decomposition_model(
                          STL(log(dollars_monthly), robust = TRUE),
                          RW(log(season_adjust) ~ drift()),
                          ETS(season_year ~ error("A") + trend("Ad") + season("N"))),
    drift_SARIMA = decomposition_model(
                          STL(log(dollars_monthly), robust = TRUE),
                          RW(log(season_adjust) ~ drift()),
                          ARIMA(season_year  ~ pdq(0,1,1) + PDQ(2,1,1))),
    ETS_SARIMA = decomposition_model(
                          STL(log(dollars_monthly), robust = TRUE),
                          ETS(season_year ~ error("A") + trend("Ad") + season("N")),
                          ARIMA(season_adjust  ~ pdq(0,1,1) + PDQ(2,1,1))),
  )

exports_comb |> accuracy() |>
  select(.model, .type, MAE, RMSE, MAPE, MASE) |>
  arrange(MAPE)
```

## Pronóstico de combinados

```{r}
#| warning: false
exports_fore <- exports_comb %>% forecast(h=12)
exports_fore %>% autoplot(exports_t %>% filter_index("2017" ~ .)) + xlab("Mes") + ylab("Dólares (USD) mensuales") + ggtitle("Pronósticos de combinados")
```

## Usando todos los datos:

```{r}
#| warning: false
exports_fore |>  
  accuracy(exports_t) |> 
  select(.model, .type, MASE, RMSE, MAPE, MAE ) |> 
  arrange(MAPE)
```

## Predección

```{r}
#| warning: false
exports_f <- exports_t |>
      model( ETS_SARIMA = decomposition_model(
                          STL(log(dollars_monthly), robust = TRUE),
                          ETS(season_year ~ error("A") + trend("Ad") + season("N")),
                          ARIMA(season_adjust  ~ pdq(0,1,1) + PDQ(2,1,1))))

exports_fore <- exports_f |> forecast(h = 12)
exports_fore |> autoplot(exports_t |> filter_index('2017' ~ .)) + ggtitle("Predicción") + xlab("Mes") + ylab("Dólares (USD) mensuales")
```

## Conclusión

- ETS_SARIMA es una predicción visualmente lógica.
- Presenta el error MAPE más bajo.
- Residuales sin correlación.

- Factible no usar todos los datos.
- Tomar en cuenta outliers.

- Error del 3%
- Muy buena predicción.


## Referencias

-   Canada, G. A. (2022a, junio 21). Highlights of Canada's Merchandise Trade Performance in 2021. GAC. 
https://www.international.gc.ca/trade-commerce/economist-economiste/analysis-analyse/merchandise_trade-commerce_marchandises-2021.aspx?lang=eng

-   Canada, G. A. (2022b, diciembre 22). State of trade 2020. GAC.
https://www.international.gc.ca/gac-amc/publications/economist-economiste/state-of-trade-commerce-international-2020.aspx?lang=eng

-   Recession of 2008--09 in Canada. (s. f.). The Canadian Encyclopedia. https://www.thecanadianencyclopedia.ca/en/article/recession-of-200809-in-canada
